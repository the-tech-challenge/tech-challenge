name: Deploy Application
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
permissions:
  id-token: write
  contents: read
jobs:
  # 1. Lookup Resources (Dynamic Configuration)
  lookup:
    name: Lookup Resources
    runs-on: ubuntu-latest
    outputs:
      ecr_repository: ${{ steps.find.outputs.ecr_repository }}
      ec2_instance_id: ${{ steps.find.outputs.ec2_instance_id }}
      alb_dns: ${{ steps.find.outputs.alb_dns }}
      aws_region: ${{ steps.find.outputs.aws_region }}
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Find Resources by Tag
        id: find
        run: |
          PROJECT_TAG="${{ vars.PROJECT_NAME || 'flask-challenge' }}"
          REGION="${{ vars.AWS_REGION || 'us-east-1' }}"
          echo "aws_region=$REGION" >> $GITHUB_OUTPUT
          
          echo "üîç Looking for resources with tag Project=$PROJECT_TAG in $REGION..."

          # 1. Find Running EC2 Instance
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=$PROJECT_TAG" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)
          
          if [ "$INSTANCE_ID" == "None" ] || [ -z "$INSTANCE_ID" ]; then
            echo "‚ùå Could not find a running EC2 instance with tag Project=$PROJECT_TAG"
            exit 1
          fi
          echo "‚úÖ Found Instance ID: $INSTANCE_ID"
          echo "ec2_instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

          # 2. Find ECR Repository Name
          # Try to find via Resource Tagging API
          REPO_ARN=$(aws resourcegroupstaggingapi get-resources \
            --tag-filters Key=Project,Values=$PROJECT_TAG \
            --resource-type-filters ecr:repository \
            --query "ResourceTagMappingList[0].ResourceARN" \
            --output text)

          if [ "$REPO_ARN" == "None" ] || [ -z "$REPO_ARN" ]; then
             echo "‚ö†Ô∏è Could not find ECR repo via tags. Falling back to default name: $PROJECT_TAG"
             REPO_NAME="$PROJECT_TAG"
          else
             # Extract name from ARN (everything after 'repository/')
             REPO_NAME=$(echo $REPO_ARN | sed 's/.*repository\///')
             echo "‚úÖ Found ECR Repo: $REPO_NAME"
          fi
          echo "ecr_repository=$REPO_NAME" >> $GITHUB_OUTPUT

          # 3. Find ALB DNS Name
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --query "LoadBalancers[?contains(LoadBalancerName, '$PROJECT_TAG')].DNSName | [0]" \
            --output text)
          
          if [ "$ALB_DNS" == "None" ] || [ -z "$ALB_DNS" ]; then
             echo "‚ö†Ô∏è Could not find ALB with name containing $PROJECT_TAG"
             ALB_DNS="Unknown"
          else
             echo "‚úÖ Found ALB DNS: $ALB_DNS"
          fi
          echo "alb_dns=$ALB_DNS" >> $GITHUB_OUTPUT

  # 2. Build and Push to ECR
  build-push:
    name: Build & Push
    needs: lookup
    uses: the-tech-challenge/github-actions-library/.github/workflows/docker-ecr.yml@main
    with:
      ecr_repository: ${{ needs.lookup.outputs.ecr_repository }}
      image_tag: ${{ github.sha }}
      aws_region: ${{ needs.lookup.outputs.aws_region }}
    secrets:
      ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_ARN }}
  
  # 3. Manual Approval Gate
  approve-deploy:
    name: Approve Deployment
    needs: build-push
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Acknowledge Approval
        run: echo "Manual approval received. Proceeding to deploy."

  # 4. Deploy to EC2
  deploy:
    name: Deploy to EC2
    needs: [lookup, build-push, approve-deploy]
    uses: the-tech-challenge/github-actions-library/.github/workflows/deploy-ec2.yml@main
    with:
      image_uri: ${{ needs.build-push.outputs.image_uri }}
      instance_id: ${{ needs.lookup.outputs.ec2_instance_id }}
      container_port: 5000
      aws_region: ${{ needs.lookup.outputs.aws_region }}
    secrets:
      ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_ARN }}

  # 5. Output URL
  show-url:
    name: Application URL
    needs: [lookup, deploy]
    runs-on: ubuntu-latest
    steps:
      - name: Verify and Display Deployment
        run: |
          DNS="${{ needs.lookup.outputs.alb_dns }}"
          URL="http://$DNS/info"
          
          echo "::notice title=Deployment Complete::Application is live at $URL"
          echo "---------------------------------------------------"
          echo "üöÄ Checking endpoint health..."
          
          # Retry curl a few times to allow for propagation/startup
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo "failed")
            if [ "$HTTP_CODE" == "200" ]; then
              echo "‚úÖ verification successful! Site is UP."
              curl -s "$URL" # Show the actual output
              break
            else
              echo "‚ö†Ô∏è Attempt $i: Site returned $HTTP_CODE. Retrying in 5s..."
              sleep 5
            fi
          done
          
          echo "---------------------------------------------------"
          echo "üîó Access URL: $URL"
          echo "---------------------------------------------------"
